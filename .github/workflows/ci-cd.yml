# =============================================================================
# CI/CD Pipeline for Dummy Project
# =============================================================================
# This workflow automates testing, building, and deploying the application.
# 
# TRIGGER: Runs on push/PR to 'main' or 'develop' branches
# 
# WORKFLOW STAGES:
# 1. TEST     - Runs linting and tests on frontend code
# 2. BUILD    - Creates Docker images and pushes to Docker Hub (main branch only)
# 3. DEPLOY   - Deploys to VPS server via SSH (main branch only)
#
# REQUIRED GITHUB SECRETS:
# - DOCKERHUB_USERNAME  : Your Docker Hub username
# - DOCKERHUB_TOKEN     : Docker Hub access token (not password)
# - VPS_HOST            : VPS server IP address
# - VPS_USER            : SSH username (e.g., root or deploy user)
# - VPS_SSH_KEY         : Private SSH key for authentication
# - VPS_PORT            : SSH port (usually 22)
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  # ===========================================================================
  # JOB 1: TEST
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
   
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        run_install: false
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Run linter
      run: echo "Linter passed - skipping for now"
      # TODO: Enable linting when ready
      # run: pnpm run lint
    
    - name: Run tests
      run: echo "Tests passed - skipping for now"
      # TODO: Enable tests when ready
      # run: pnpm run test
      
    - name: Test build
      run: pnpm run build
      env:
        CI: false

  # ===========================================================================
  # JOB 2: BUILD DOCKER IMAGES
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
   
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-backend:latest
    
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./frontend/Dockerfile-production
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-frontend:latest
        build-args: |
          VITE_API_URL=http://${{ secrets.VPS_HOST }}:3001
        
    - name: Upload build completion status
      run: echo "Docker images built and pushed successfully"

  # ===========================================================================
  # JOB 3: DEPLOY TO PRODUCTION VPS
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # ===================================================================
          # DEPLOYMENT SCRIPT - Runs on VPS server
          # ===================================================================
          
          set -e
          set -o pipefail
          
          echo "=== Starting Deployment ==="
          
          # Navigate to project directory
          cd /opt/DummyProject || exit 1
          
          # Pull latest code from GitHub
          echo "Checking for configuration updates..."
          if [ -d ".git" ]; then
            echo "Pulling latest configuration from GitHub..."
            git pull origin main || echo "Warning: Could not pull latest code."
          fi
          
          # Ensure uploads directory exists
          echo "Setting up uploads directory..."
          sudo mkdir -p ./backend/uploads/images
          sudo chown -R 1000:1000 ./backend/uploads
          sudo chmod -R 755 ./backend/uploads
          
          # Update Docker Hub username in environment file
          echo "Updating environment configuration..."
          grep -q "^DOCKERHUB_USERNAME=" .env.production && \
            sed -i "s|^DOCKERHUB_USERNAME=.*|DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}|" .env.production || \
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env.production
          
          # Login to Docker Hub
          echo "Logging into Docker Hub..."
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || exit 1
          
          # Remove old cached images
          echo "Removing old Docker images..."
          sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/dummy-backend:latest || true
          sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/dummy-frontend:latest || true
          
          # Pull new images from Docker Hub
          echo "Pulling latest Docker images..."
          if ! sudo docker compose -f docker-compose.prod.yml --env-file .env.production pull backend frontend; then
            echo "ERROR: Failed to pull images!"
            exit 1
          fi
          
          # Stop and remove old containers
          echo "Stopping old containers..."
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production stop backend frontend || true
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production rm -f backend frontend || true
          
          # Start new containers
          echo "Starting new containers..."
          if ! sudo docker compose -f docker-compose.prod.yml --env-file .env.production up -d backend frontend; then
            echo "ERROR: Failed to start containers"
            sudo docker compose -f docker-compose.prod.yml --env-file .env.production logs --tail 100
            exit 1
          fi
          
          # Wait for initialization
          echo "Waiting for containers to initialize..."
          sleep 20
          
          # Verify deployment
          echo "Verifying deployment..."
          sudo docker ps -a | grep dummy || true
          
          BACKEND_STATUS=$(sudo docker ps --filter "name=dummy-backend-prod" --format "{{.Status}}" 2>/dev/null || echo "")
          FRONTEND_STATUS=$(sudo docker ps --filter "name=dummy-frontend-prod" --format "{{.Status}}" 2>/dev/null || echo "")
          
          if [ -z "$BACKEND_STATUS" ]; then
            echo "ERROR: Backend container is not running!"
            sudo docker logs dummy-backend-prod --tail 100 2>&1 || true
            exit 1
          fi
          
          if [ -z "$FRONTEND_STATUS" ]; then
            echo "ERROR: Frontend container is not running!"
            sudo docker logs dummy-frontend-prod --tail 100 2>&1 || true
            exit 1
          fi
          
          echo ""
          echo "=== Container Status ==="
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production ps
          
          echo ""
          echo "=========================================="
          echo "   DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo "Frontend: http://${{ secrets.VPS_HOST }}"
          echo "Backend:  http://${{ secrets.VPS_HOST }}:3001"
          echo "=========================================="
