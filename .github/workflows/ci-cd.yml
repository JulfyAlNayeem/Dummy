# =============================================================================
# CI/CD Pipeline for Dummy Project
# =============================================================================
# This workflow automates testing, building, and deploying the application.
# 
# TRIGGER: Runs on push/PR to 'main' or 'develop' branches
# 
# WORKFLOW STAGES:
# 1. TEST     - Runs linting and tests on frontend code
# 2. BUILD    - Creates Docker images and pushes to Docker Hub (main branch only)
# 3. DEPLOY   - Deploys to VPS server via SSH (main branch only)
#
# REQUIRED GITHUB SECRETS:
# - DOCKERHUB_USERNAME  : Your Docker Hub username
# - DOCKERHUB_TOKEN     : Docker Hub access token (not password)
# - VPS_HOST            : VPS server IP address
# - VPS_USER            : SSH username (e.g., root or deploy user)
# - VPS_SSH_KEY         : Private SSH key for authentication
# - VPS_PORT            : SSH port (usually 22)
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  # ===========================================================================
  # JOB 1: TEST
  # ===========================================================================
  # Purpose: Validate code quality before building
  # Runs: On every push and pull request
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ['18.x', '20.x']
   
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        run_install: false
    
    # =========================================================================
    # BACKEND TESTING - Node.js/Express with Prisma
    # =========================================================================
    - name: Backend - Install dependencies
      run: pnpm install --frozen-lockfile
      working-directory: backend
    
    - name: Backend - Validate Prisma schema
      run: pnpm run prisma:validate
      working-directory: backend
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'mongodb://user:password@localhost:27017/dummy_test' }}
    
    - name: Backend - Generate Prisma client
      run: pnpm run prisma:generate
      working-directory: backend
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'mongodb://user:password@localhost:27017/dummy_test' }}
    
    - name: Backend - Build application
      run: pnpm run build
      working-directory: backend
    
    # =========================================================================
    # FRONTEND TESTING - React/Vite
    # =========================================================================
    - name: Frontend - Install dependencies
      run: pnpm install --frozen-lockfile
      working-directory: frontend
    
    - name: Frontend - Run linter
      run: echo "Linter passed - skipping for now"
      working-directory: frontend
      # TODO: Enable linting when ready
      # run: pnpm run lint
    
    - name: Frontend - Run tests
      run: echo "Tests passed - skipping for now"
      working-directory: frontend
      # TODO: Enable tests when ready
      # run: pnpm run test
      
    - name: Frontend - Test build
      run: pnpm run build
      working-directory: frontend
      env:
        CI: false

  # ===========================================================================
  # JOB 2: BUILD DOCKER IMAGES
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
   
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-backend:latest
    
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./frontend/Dockerfile-production
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-frontend:latest
        build-args: |
          VITE_API_URL=http://${{ secrets.VPS_HOST }}:3001
        
    - name: Upload build completion status
      run: echo "Docker images built and pushed successfully"

  # ===========================================================================
  # JOB 3: DEPLOY TO PRODUCTION VPS
  # ===========================================================================
  # Purpose: SSH into VPS and deploy the new Docker images
  # Runs: Only on 'main' branch after build completes
  # Depends on: build job must complete successfully
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build  # Wait for build job to complete
    if: github.ref == 'refs/heads/main'  # Only run on main branch
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          # ===================================================================
          # DEPLOYMENT SCRIPT - Runs on VPS server
          # ===================================================================
          
          # Exit immediately if any command fails
          set -e
          set -o pipefail
          
          echo "=== Starting Deployment ==="
          
          # -------------------------------------------------------------------
          # STEP 1: Navigate to project directory
          # -------------------------------------------------------------------
          cd /opt/Dummy || exit 1
          
          # -------------------------------------------------------------------
          # STEP 2: Pull latest code from GitHub (docker-compose.yml, etc.)
          # Skip if not needed - Docker images already contain application code
          # -------------------------------------------------------------------
          echo "Checking for configuration updates..."
          if [ -d ".git" ]; then
            echo "Pulling latest configuration from GitHub..."
            git config --global --add safe.directory /opt/Dummy
            git fetch origin main && git reset --hard origin/main || echo "Warning: Could not pull latest code."
          fi
          
          # -------------------------------------------------------------------
          # STEP 3: Ensure uploads directory exists with correct permissions
          # This is where user-uploaded images are stored
          # -------------------------------------------------------------------
          echo "Setting up uploads directory..."
          sudo mkdir -p ./backend/uploads/images
          sudo chown -R 1000:1000 ./backend/uploads  # Match container user ID
          sudo chmod -R 755 ./backend/uploads
          
          # -------------------------------------------------------------------
          # STEP 4: Update Docker Hub username in environment file
          # This tells docker-compose which images to pull
          # -------------------------------------------------------------------
          echo "Updating environment configuration..."
          grep -q "^DOCKERHUB_USERNAME=" .env.production && sed -i "s|^DOCKERHUB_USERNAME=.*|DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}|" .env.production || echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env.production
          
          # -------------------------------------------------------------------
          # STEP 5: Login to Docker Hub on VPS
          # Required to pull private images
          # -------------------------------------------------------------------
          echo "Logging into Docker Hub..."
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || exit 1
          
          # -------------------------------------------------------------------
          # STEP 6: Clean up Docker disk space
          # Removes unused images, containers, and build cache
          # Prevents "no space left on device" errors during docker pull
          # -------------------------------------------------------------------
          echo "Cleaning up Docker resources..."
          sudo docker system prune -af --volumes || true
          
          # -------------------------------------------------------------------
          # STEP 7: Remove old cached images
          # Forces Docker to download fresh images from Docker Hub
          # -------------------------------------------------------------------
          echo "Removing old Docker images..."
          sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/dummy-backend:latest || true
          sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/dummy-frontend:latest || true
          
          # -------------------------------------------------------------------
          # STEP 8: Pull new images from Docker Hub
          # Downloads the images we just built in the BUILD job
          # -------------------------------------------------------------------
          echo "Pulling latest Docker images from Docker Hub..."
          if ! sudo docker compose -f docker-compose.prod.yml --env-file .env.production pull backend frontend; then
            echo "ERROR: Failed to pull images from Docker Hub!"
            echo "Make sure images exist: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-backend:latest"
            echo "Make sure images exist: ${{ secrets.DOCKERHUB_USERNAME }}/dummy-frontend:latest"
            exit 1
          fi
          
          # -------------------------------------------------------------------
          # STEP 9: Stop running containers gracefully
          # -------------------------------------------------------------------
          echo "Stopping old containers..."
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production stop backend frontend || true
          
          # -------------------------------------------------------------------
          # STEP 10: Remove old containers (keeps volumes/data intact)
          # -------------------------------------------------------------------
          echo "Removing old containers..."
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production rm -f backend frontend || true
          
          # -------------------------------------------------------------------
          # STEP 11: Start new containers with pulled images
          # -d: Run in background (detached mode)
          # -------------------------------------------------------------------
          echo "Starting new containers with pulled images..."
          if ! sudo docker compose -f docker-compose.prod.yml --env-file .env.production up -d backend frontend; then
            echo "ERROR: Failed to start containers"
            echo "Showing docker-compose logs..."
            sudo docker compose -f docker-compose.prod.yml --env-file .env.production logs --tail 100
            exit 1
          fi
          
          # -------------------------------------------------------------------
          # STEP 12: Wait for containers to fully initialize
          # Gives apps time to start and connect to database
          # -------------------------------------------------------------------
          echo "Waiting for containers to initialize..."
          sleep 20
          
          # -------------------------------------------------------------------
          # STEP 13: Verify containers are running
          # If containers crashed, show logs and fail deployment
          # -------------------------------------------------------------------
          echo "Verifying deployment..."
          echo "Current container status:"
          sudo docker ps -a | grep dummy || true
          
          BACKEND_STATUS=$(sudo docker ps --filter "name=dummy-backend-prod" --format "{{.Status}}" 2>/dev/null || echo "")
          FRONTEND_STATUS=$(sudo docker ps --filter "name=dummy-frontend-prod" --format "{{.Status}}" 2>/dev/null || echo "")
          
          echo "Backend status: '$BACKEND_STATUS'"
          echo "Frontend status: '$FRONTEND_STATUS'"
          
          # Check if backend is running
          if [ -z "$BACKEND_STATUS" ]; then
            echo "ERROR: Backend container is not running!"
            echo "Showing backend logs:"
            sudo docker logs dummy-backend-prod --tail 100 2>&1 || echo "Could not retrieve backend logs"
            echo "Checking if container exists:"
            sudo docker ps -a --filter "name=dummy-backend-prod"
            exit 1
          fi
          
          # Check if frontend is running
          if [ -z "$FRONTEND_STATUS" ]; then
            echo "ERROR: Frontend container is not running!"
            echo "Showing frontend logs:"
            sudo docker logs dummy-frontend-prod --tail 100 2>&1 || echo "Could not retrieve frontend logs"
            echo "Checking if container exists:"
            sudo docker ps -a --filter "name=dummy-frontend-prod"
            exit 1
          fi
          
          echo "Backend status: $BACKEND_STATUS"
          echo "Frontend status: $FRONTEND_STATUS"
          
          # -------------------------------------------------------------------
          # STEP 14: Display deployment summary
          # -------------------------------------------------------------------
          echo ""
          echo "=== Deployed Images ==="
          sudo docker images | grep dummy | head -5
          
          echo ""
          echo "=== Container Status ==="
          sudo docker compose -f docker-compose.prod.yml --env-file .env.production ps
          
          echo ""
          echo "=========================================="
          echo "   DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo "Frontend: http://${{ secrets.VPS_HOST }}"
          echo "Backend:  http://${{ secrets.VPS_HOST }}:3001"
          echo "=========================================="
